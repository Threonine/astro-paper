---
title: 差分分析学习（一）
description: 从 0 开始的差分分析学习！
pubDatetime: 2024-10-20T20:30:06+08:00
featured: false
draft: false
tags:
  - 分组密码
  - Crypto
  - 差分分析
---

本文是对 *The Block Cipher Companion* 的读书笔记

## 引入

我们熟悉的异或加密可以写成
$$
c = m\oplus k
$$
香农证明了如果随机选择的 k 只使用过 1 次（即一次性密码本，OTP），异或加密是无条件安全的.而如果 k 被使用了 2 次，攻击者可以根据两个密文来计算两个消息的异或：
$$
c_0\oplus c_1 =(m_0\oplus k)\oplus (m_1\oplus k)= m_0\oplus m_1
$$
在消息中包含冗余的情况下，攻击者可以从中推断出明文的信息.

从这个例子中我们可以学到：相比于只考虑 1 对明文-密文，考虑 **多对** 明文-密文之间的关系可能会让攻击者获得更多的信息.

## CipherOne

 $$
 c = S [m \oplus k_0] \oplus k_1
 $$

其中 S 盒为

| $x$    | $\texttt{0}$ | $\texttt{1}$ | $\texttt{2}$ | $\texttt{3}$ | $\texttt{4}$ | $\texttt{5}$ | $\texttt{6}$ | $\texttt{7}$ |
| ------ | ------------ | ------------ | ------------ | ------------ | ------------ | ------------ | ------------ | ------------ |
| $S[x]$ | $\texttt{6}$ | $\texttt{4}$ | $\texttt{c}$ | $\texttt{5}$ | $\texttt{0}$ | $\texttt{7}$ | $\texttt{2}$ | $\texttt{e}$ |
| $x$    | $\texttt{8}$ | $\texttt{9}$ | $\texttt{a}$ | $\texttt{b}$ | $\texttt{c}$ | $\texttt{d}$ | $\texttt{e}$ | $\texttt{f}$ |
| $S[x]$ | $\texttt{1}$ | $\texttt{f}$ | $\texttt{3}$ | $\texttt{d}$ | $\texttt{8}$ | $\texttt{a}$ | $\texttt{9}$ | $\texttt{b}$ |

假设攻击者知道两个明文-密文对 $(m_0,c_0),(m_1,c_1)$. 将加密过程逐步展开如下

| **CipherOne** $(m_0, k_0 \parallel k_1)$ | **CipherOne** $(m_1, k_0 \parallel k_1)$ |
| --------------------------------------- | --------------------------------------- |
| $u_0 = m_0 \oplus k_0$                  | $u_1 = m_1 \oplus k_0$                  |
| $v_0 = S[u_0]$                          | $v_1 = S[u_1]$                          |
| $c_0 = v_0 \oplus k_1$                  | $c_1 = v_1 \oplus k_1$                  |

由于 $k_0$ 是保密的，攻击者无法获取 $u_0,u_1$ 的值. 然而，当我们引入 **差分** 的概念时，攻击者实际上是知道它们的差分的：
$$
u_0\oplus u_1 =(m_0\oplus k_0)\oplus (m_1\oplus k_0)= m_0\oplus m_1
$$
对于正确的 $k_1$，有 $u_0\oplus u_1=S^{-1}[v_0]\oplus S^{-1}[v_1]$，攻击者可以简单地尝试所有可能的 $k_1$ 值 $t$，一旦获得期望的 $S^{-1}[v_0]\oplus S^{-1}[v_1]$ （也就是等于已知值 $u_0\oplus u_1$），那么 $t$ 就是一个可能的密钥！接下来可以重复这样的攻击，直到候选的密钥唯一.

从对 CipherOne 的攻击中我们可以学到：

1. 尽管我们可能不知道加密过程中内部变量的值，但我们能 **描述这些变量的差分**！
2. 我们能够 **猜测部分密钥的值**，并 **测试某些差分条件是否成立** 来恢复密钥信息！

关于第一点，在 CipherOne 中，我们可以 **确定地** 描述内部变量之间的差分，但在更复杂的密码中，这种描述可能是 **不确定的**. 接下来请看 CipherTwo.

## CipherTwo

 $$
 c = S [S[m \oplus k_0] \oplus k_1]\oplus k_2
 $$
假设攻击者知道两个明文-密文对 $(m_0,c_0),(m_1,c_1)$. 将加密过程分步写为

| **CipherOne** $(m_0, k_0 \parallel k_1 \parallel k_2)$ | **CipherOne** $(m_1, k_0 \parallel k_1 \parallel k_2)$ |
| ----------------------------------------------------- | ----------------------------------------------------- |
| $u_0 = m_0 \oplus k_0$                                | $u_1 = m_1 \oplus k_0$                                |
| $v_0 = S[u_0]$                                        | $v_1 = S[u_1]$                                        |
| $w_0 = v_0 \oplus k_1$                                | $w_1 = v_1 \oplus k_1$                                |
| $x_0=S[w_0]$                                          | $x_1=S[w_1]$                                          |
| $c_0=x_0\oplus k_2$                                   | $c_1=x_1\oplus k_2$                                   |

按照 CipherOne 的方法从下往上分析，通过猜测 $k_2$ 的值来计算 $x_0,x_1$，进而得到 $w_0,w_1$. 这时遇到了 $k_1$ ，所以没法直接得到 $v_0,v_1$，不过别忘了，计算差分 $w_0\oplus w_1$ 让我们能够得到 $v_0\oplus v_1$.

从上往下分析，我们知道 $m_0\oplus m_1$，也就是知道 $u_0\oplus u_1$.

这时候我们会发现，$v_0\oplus v_1$ 和 $u_0\oplus u_1$ 之间隔了一个 S 盒，而 S 盒是 **非线性的**，这阻断了我们对 $k_2$ 猜测的验证.

### 理解 S 盒的行为

$v_0\oplus v_1$ 和 $u_0\oplus u_1$ 之间隔了一个 S 盒，这个 S 盒究竟做了什么？

先讨论一个特殊情况：对于 S 盒的两个输入，$i$ 和 $j$ ，其中 $j=i\oplus \texttt{f}$. 对于 $i$ 的所有值，我们计算如下：

|            i |            j |         S [i] |         S [j] |  S [i] ^ S [j] |
|--------------|--------------|--------------|--------------|--------------|
| $\texttt{0}$ | $\texttt{f}$ | $\texttt{6}$ | $\texttt{b}$ | $\texttt{d}$ |
| $\texttt{1}$ | $\texttt{e}$ | $\texttt{4}$ | $\texttt{9}$ | $\texttt{d}$ |
| $\texttt{2}$ | $\texttt{d}$ | $\texttt{c}$ | $\texttt{a}$ | $\texttt{6}$ |
| $\texttt{3}$ | $\texttt{c}$ | $\texttt{5}$ | $\texttt{8}$ | $\texttt{d}$ |
| $\texttt{4}$ | $\texttt{b}$ | $\texttt{0}$ | $\texttt{d}$ | $\texttt{d}$ |
| $\texttt{5}$ | $\texttt{a}$ | $\texttt{7}$ | $\texttt{3}$ | $\texttt{4}$ |
| $\texttt{6}$ | $\texttt{9}$ | $\texttt{2}$ | $\texttt{f}$ | $\texttt{d}$ |
| $\texttt{7}$ | $\texttt{8}$ | $\texttt{e}$ | $\texttt{1}$ | $\texttt{f}$ |
| $\texttt{8}$ | $\texttt{7}$ | $\texttt{1}$ | $\texttt{e}$ | $\texttt{f}$ |
| $\texttt{9}$ | $\texttt{6}$ | $\texttt{f}$ | $\texttt{2}$ | $\texttt{d}$ |
| $\texttt{a}$ | $\texttt{5}$ | $\texttt{3}$ | $\texttt{7}$ | $\texttt{4}$ |
| $\texttt{b}$ | $\texttt{4}$ | $\texttt{d}$ | $\texttt{0}$ | $\texttt{d}$ |
| $\texttt{c}$ | $\texttt{3}$ | $\texttt{8}$ | $\texttt{5}$ | $\texttt{d}$ |
| $\texttt{d}$ | $\texttt{2}$ | $\texttt{a}$ | $\texttt{c}$ | $\texttt{6}$ |
| $\texttt{e}$ | $\texttt{1}$ | $\texttt{9}$ | $\texttt{4}$ | $\texttt{d}$ |
| $\texttt{f}$ | $\texttt{0}$ | $\texttt{b}$ | $\texttt{6}$ | $\texttt{d}$ |

很容易注意到 `S[i] ^ S[j]` 这一列并不均匀，`d` 在 16 次中出现了 10 次. 前面提到，我们对 $k_2$ 的猜测被阻断了. 如果我们能够指定消息去进行加密，而不是只是简单地截取明文-密文对（也就是能够进行 **选择密文攻击**），我们就能够利用这种不均匀的概率分布：

随机选择 $m_1$，令 $m_1=m_0\oplus \texttt{f}$，我们能够知道 $u_0\oplus u_1=m_0\oplus m_1=\texttt{f}$. 当然，我们无法直接确切地知道 $u_0,u_1$ 具体的取值，不过根据上面的表，我们能够确定： $S[u_0]\oplus S[u_1]=\texttt{d}$ 成立的概率为 $\frac{10}{16}$.

这就为验证 $k_2$ 的正确性提供了依据：我们可以假设，如果 $k_2$ 的猜测是错的，那么 $v_0\oplus v_1$ 应该「看上去很随机」. 实际上我们可以这样做：维护一组初始化为 0 的计数器（对应 $k_2$ 的每一种取值），对于一个给定的明文-密文对，遍历所有可能的 $k_2$ 值，如果 $v_0\oplus v_1=\texttt{d}$，那么将对应计数器的值 +1. 注意正确的 $k_2$ 使得这个关系成立的概率是 $\frac{10}{16}$，而错误的 $k_2$ 使得这个关系成立的概率只有 $\frac{1}{10}$. 如果我们使用 N 个明文-密文对，正确的 $k_2$ 对应的计数器应该明显大于其他计数器.

刚刚我们是在讨论 $j=i\oplus \texttt{f}$ 的特殊情况，实际上我们可以对所有可能的输入差分进行类似操作，画出一张 **差分分布表**. 每一行表示一个输入 $d_{in}$ ，表中每项表示对应的输出 $d_{out}$ 出现的频率.

|   | 0  | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | a | b | c | d  | e | f |
|---|----|---|---|---|---|---|---|---|---|---|---|---|---|----|---|---|
| 0 | 16 | - | - | - | - | - | - | - | - | - | - | - | - | -  | - | - |
| 1 | -  | - | 6 | - | - | - | - | 2 | - | 2 | - | - | 2 | -  | 4 | - |
| 2 | -  | 6 | 6 | - | - | - | - | - | - | 2 | 2 | - | - | -  | - | - |
| 3 | -  | - | - | 6 | - | 2 | - | - | 2 | - | - | - | 4 | -  | 2 | - |
| 4 | -  | - | - | 2 | - | 2 | 4 | - | - | 2 | 2 | 2 | - | -  | 2 | - |
| 5 | -  | 2 | 2 | - | 4 | - | - | 4 | 2 | - | - | 2 | - | -  | - | - |
| 6 | -  | - | 2 | - | 4 | - | - | 2 | 2 | - | 2 | 2 | 2 | -  | - | - |
| 7 | -  | - | - | - | - | 4 | 4 | - | 2 | 2 | 2 | 2 | - | -  | - | - |
| 8 | -  | - | - | - | - | 2 | - | 2 | 4 | - | - | 4 | - | 2  | - | 2 |
| 9 | -  | 2 | - | - | - | 2 | 2 | 2 | - | 4 | 2 | - | - | -  | - | 2 |
| a | -  | - | - | - | 2 | 2 | - | - | - | 4 | 4 | - | 2 | 2  | - | - |
| b | -  | - | - | 2 | 2 | - | 2 | 2 | 2 | - | - | 4 | - | -  | 2 | - |
| c | -  | 4 | - | 2 | - | 2 | - | - | 2 | - | - | - | - | -  | 6 | - |
| d | -  | - | - | - | - | - | 2 | 2 | - | - | - | - | 6 | 2  | - | 4 |
| e | -  | 2 | - | 4 | 2 | - | - | - | - | - | 2 | - | - | -  | - | 6 |
| f | -  | - | - | - | 2 | - | 2 | - | - | - | - | - | - | 10 | - | 2 |
